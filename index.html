<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•œì¼ ë²ˆì—­ê¸°</title>
    <style>
        body { font-family: sans-serif; max-width: 600px; margin: 20px auto; padding: 0 20px; }
        
        /* íƒ­ UI ìŠ¤íƒ€ì¼ */
        .tabs { display: flex; margin-bottom: 20px; border-bottom: 2px solid #ccc; }
        .tab-button { flex: 1; padding: 10px; cursor: pointer; border: none; background: none; font-size: 16px; color: #555; }
        .tab-button.active { font-weight: bold; border-bottom: 2px solid #007bff; margin-bottom: -2px; color: #007bff; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        textarea { width: 100%; height: 100px; margin-bottom: 10px; padding: 10px; box-sizing: border-box; }
        button.action-btn { padding: 10px 15px; margin: 5px 5px 5px 0; cursor: pointer; }
        #output { margin-top: 20px; padding: 15px; background-color: #f4f4f4; border-radius: 5px; min-height: 50px; }
        .time-log { font-size: 0.85em; color: #555; margin-top: 10px; }
        
        /* ì´ë ¥ UI ìŠ¤íƒ€ì¼ */
        .history-item { padding: 10px 0; border-bottom: 1px dashed #eee; font-size: 0.95em; }
        .history-empty { color: #999; padding: 20px 0; text-align: center; }

        /* í† í° ì§„í–‰ë¥  í‘œì‹œì¤„ ìŠ¤íƒ€ì¼ */
        .progress-container { width: 100%; background-color: #e0e0e0; border-radius: 5px; margin: 15px 0; height: 25px; overflow: hidden; }
        .progress-bar { height: 100%; background-color: #28a745; width: 0%; transition: width 0.3s ease; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.85em; font-weight: bold; }
        .token-info { font-size: 0.95em; line-height: 1.6; }
    </style>
</head>
<body>
    <h2>ì´ˆê²½ëŸ‰ í•œì¼ ë²ˆì—­ê¸°</h2>

    <div class="tabs">
        <button class="tab-button active" onclick="switchTab(event, 'translateTab')">ë²ˆì—­ê¸°</button>
        <button class="tab-button" onclick="switchTab(event, 'historyTab')">ë²ˆì—­ ì´ë ¥</button>
        <button class="tab-button" onclick="switchTab(event, 'tokenTab')">í† í° ì‚¬ìš©ëŸ‰</button>
    </div>

    <div id="translateTab" class="tab-content active">
        <textarea id="inputText" placeholder="í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ê±°ë‚˜ í•˜ë‹¨ì˜ ìŒì„± ë²„íŠ¼ì„ ëˆ„ë¥´ì‹­ì‹œì˜¤."></textarea>
        
        <div>
            <button class="action-btn" onclick="translateText('KO', 'JA')">í…ìŠ¤íŠ¸ ë²ˆì—­ (í•œ â†’ ì¼)</button>
        </div>
        <div style="margin-top: 10px;">
            <button class="action-btn" onclick="startSpeechRecognition('ko-KR', 'KO', 'JA')">ğŸ¤ í•œêµ­ì–´ ìŒì„± ë²ˆì—­ (í•œ â†’ ì¼)</button>
            <button class="action-btn" onclick="startSpeechRecognition('ja-JP', 'JA', 'KO')">ğŸ¤ ì¼ë³¸ì–´ ìŒì„± ë²ˆì—­ (ì¼ â†’ í•œ)</button>
        </div>

        <div id="output">ê²°ê³¼ ëŒ€ê¸° ì¤‘...</div>
    </div>

    <div id="historyTab" class="tab-content">
        <div id="historyList">
            <div class="history-empty">ê¸°ë¡ëœ ë²ˆì—­ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</div>
        </div>
    </div>

    <div id="tokenTab" class="tab-content">
        <h3>ì˜¤ëŠ˜ì˜ í† í° ì‚¬ìš© í˜„í™©</h3>
        <div class="progress-container">
            <div id="tokenProgressBar" class="progress-bar">0%</div>
        </div>
        <div class="token-info">
            <div>ì¼ì¼ í• ë‹¹ëŸ‰: <span id="totalTokenLimitDisplay"></span> í† í°</div>
            <div>ì˜¤ëŠ˜ ì†Œëª¨í•œ í† í°: <strong id="usedTokensDisplay">0</strong> í† í°</div>
            <div>ì”ì—¬ í† í°: <strong id="remainingTokensDisplay">0</strong> í† í°</div>
        </div>
    </div>

    <script>
        // ì¼ì¼ í† í° í•œë„ ì„¤ì • (ì„ì˜ì˜ ê°’ ì ìš©. í•„ìš”ì— ë”°ë¼ ìˆ˜ì • ê°€ëŠ¥)
        const DAILY_TOKEN_LIMIT = 100000;
        document.getElementById('totalTokenLimitDisplay').innerText = DAILY_TOKEN_LIMIT.toLocaleString();

        // ë‚ ì§œ ê¸°ì¤€ ë¬¸ìì—´ ìƒì„± (YYYY-MM-DD)
        function getTodayString() {
            const today = new Date();
            return `${today.getFullYear()}-${today.getMonth() + 1}-${today.getDate()}`;
        }

        // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ì¼ì¼ í† í° ì‚¬ìš©ëŸ‰ ë¡œë“œ ë° ë‚ ì§œ ê°±ì‹  ì²˜ë¦¬
        function loadTokenUsage() {
            const todayStr = getTodayString();
            const savedDate = localStorage.getItem('tokenDate');
            
            if (savedDate !== todayStr) {
                localStorage.setItem('tokenDate', todayStr);
                localStorage.setItem('dailyTokens', '0');
                return 0;
            }
            return parseInt(localStorage.getItem('dailyTokens') || '0', 10);
        }

        // í† í° UI ê°±ì‹ 
        function updateTokenUI() {
            const usedTokens = loadTokenUsage();
            const remainingTokens = Math.max(0, DAILY_TOKEN_LIMIT - usedTokens);
            const percentage = Math.min(100, (usedTokens / DAILY_TOKEN_LIMIT) * 100);

            document.getElementById('usedTokensDisplay').innerText = usedTokens.toLocaleString();
            document.getElementById('remainingTokensDisplay').innerText = remainingTokens.toLocaleString();
            
            const progressBar = document.getElementById('tokenProgressBar');
            progressBar.style.width = percentage + '%';
            progressBar.innerText = percentage.toFixed(2) + '%';
            
            // í•œë„ ì´ˆê³¼ ìœ„í—˜ ì‹œ ìƒ‰ìƒ ë³€ê²½
            if (percentage > 90) {
                progressBar.style.backgroundColor = '#dc3545'; // ë¹¨ê°„ìƒ‰
            } else if (percentage > 70) {
                progressBar.style.backgroundColor = '#ffc107'; // ë…¸ë€ìƒ‰
            } else {
                progressBar.style.backgroundColor = '#28a745'; // ë…¹ìƒ‰
            }
        }

        // ì´ˆê¸° UI ë Œë”ë§
        updateTokenUI();

        // í† í° ëˆ„ì  í•¨ìˆ˜
        function addDailyTokens(tokens) {
            let current = loadTokenUsage();
            current += tokens;
            localStorage.setItem('dailyTokens', current.toString());
            updateTokenUI();
        }

        // íƒ­ ì „í™˜ ë¡œì§
        function switchTab(event, tabId) {
            const contents = document.querySelectorAll('.tab-content');
            contents.forEach(content => content.classList.remove('active'));

            const buttons = document.querySelectorAll('.tab-button');
            buttons.forEach(button => button.classList.remove('active'));

            document.getElementById(tabId).classList.add('active');
            event.currentTarget.classList.add('active');
        }

        // ë²ˆì—­ ì´ë ¥ ì €ì¥ìš© ë°°ì—´
        let translationHistory = [];

        function updateHistoryUI() {
            const historyList = document.getElementById('historyList');
            if (translationHistory.length === 0) {
                historyList.innerHTML = '<div class="history-empty">ê¸°ë¡ëœ ë²ˆì—­ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }
            
            historyList.innerHTML = '';
            translationHistory.forEach((item) => {
                const div = document.createElement('div');
                div.className = 'history-item';
                div.innerHTML = `<strong>[${item.time}ì´ˆ / ${item.tokens} í† í°]</strong> ${item.original} â” <strong>${item.translated}</strong>`;
                historyList.appendChild(div);
            });
        }

        function addHistory(original, translated, timeTaken, tokenCount) {
            translationHistory.unshift({ original, translated, time: timeTaken, tokens: tokenCount });
            if (translationHistory.length > 10) {
                translationHistory.pop();
            }
            updateHistoryUI();
        }

        async function translateText(source, target, textToTranslate = null) {
            const text = textToTranslate || document.getElementById('inputText').value.trim();
            if (!text) return alert("ë²ˆì—­í•  í…ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.");

            const outputDiv = document.getElementById('output');
            outputDiv.innerHTML = "ë²ˆì—­ ì§„í–‰ ì¤‘...";

            const startTime = performance.now();

            try {
                const response = await fetch('/translate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: text, source_lang: source, target_lang: target })
                });
                const data = await response.json();
                
                const endTime = performance.now();
                const timeTaken = ((endTime - startTime) / 1000).toFixed(2);

                if (response.ok) {
                    const tokensUsed = data.token_count || 0;
                    outputDiv.innerHTML = `${data.translated_text}<div class="time-log">ì†Œìš” ì‹œê°„: ${timeTaken}ì´ˆ | ì†Œëª¨ í† í°: ${tokensUsed}</div>`;
                    
                    addHistory(text, data.translated_text, timeTaken, tokensUsed);
                    addDailyTokens(tokensUsed);
                } else {
                    outputDiv.innerText = "ì„œë²„ ì˜¤ë¥˜: " + data.detail;
                }
            } catch (error) {
                outputDiv.innerText = "í†µì‹  ì˜¤ë¥˜: " + error.message;
            }
        }

        function startSpeechRecognition(langCode, sourceLang, targetLang) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                alert("ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. Chrome, Edge ë“±ì„ ì‚¬ìš©í•˜ì‹­ì‹œì˜¤.");
                return;
            }

            const recognition = new SpeechRecognition();
            recognition.lang = langCode;
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            recognition.onstart = function() {
                document.getElementById('output').innerText = "ìŒì„± ì…ë ¥ ëŒ€ê¸° ì¤‘...";
            };

            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                document.getElementById('inputText').value = transcript;
                translateText(sourceLang, targetLang, transcript);
            };

            recognition.onerror = function(event) {
                document.getElementById('output').innerText = "ìŒì„± ì¸ì‹ ì‹¤íŒ¨: " + event.error;
            };

            recognition.start();
        }
    </script>
</body>
</html>
